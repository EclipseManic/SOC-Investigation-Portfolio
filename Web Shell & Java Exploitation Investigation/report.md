# Web Shell & Java Exploitation ‚Äî JustSomePages

## üìå Case Overview

**Sherlock Scenario:** JustSomePages (Hack The Box)

<img width="1429" height="890" alt="Screenshot 2026-02-24 095433" src="https://github.com/user-attachments/assets/7247be3c-3663-44d8-b539-e70b21ab0fa7" />

The Security Operations Center (SOC) initiated an investigation following alerts for suspicious inbound HTTP traffic targeting a public-facing Java application. Subsequent alerts indicated anomalous internal database connections originating from the web server.

The objective of this investigation was to analyze network traffic (PCAP) and endpoint telemetry to validate the alerts, identify the initial access vector, and determine the extent of post-exploitation activity.

---

## üß≠ Investigation Summary & SOC Triage

* **Initial Access:** The attacker exploited a PrimeFaces vulnerability using HTTP Form URL Encoded parameters.
* **WAF Bypass:** The malicious payload bypassed the Web Application Firewall (WAF) by utilizing Base64 encoding and remaining under the configured byte-length inspection threshold.
* **Privilege Escalation:** The attacker authenticated to the Tomcat Manager endpoint and deployed a `.war` archive containing JSP web shells.
* **Lateral Movement Indicator:** Network traffic showed NTLMSSP authentication attempts to an internal MS SQL server (Port 1433) originating from the compromised web server process.
* **Data Staging:** Active Directory database files (`ntds.dit`, `SAM`) were copied to the public IIS web directory (`C:\inetpub\wwwroot\`), triggering data staging alerts.

---

## 1Ô∏è‚É£ Alert Triage & Initial Access Analysis

**Data Source:** Network Packet Capture (PCAP) / HTTP Access Logs

Traffic analysis of the web server's ingress traffic revealed a targeted exploit against the Java Server Faces (JSF) application.

The attacker sent an HTTP POST request utilizing specific PrimeFaces parameters (`pfdrt="sc"`, `ln="primefaces"`) and passed a Base64 encoded payload into the `pfdrid` parameter. Command injections, such as `cmd="whoami"`, were appended to this payload.

**WAF Configuration Limitation:**
The investigation identified a limitation in the existing WAF configuration. The WAF is currently set to block Base64 strings that exceed a specific byte-length threshold. The encoded payload used in this incident fell below that threshold, allowing the traffic to pass uninspected.

### Evidence

* PCAP analysis showing the HTTP Form URL Encoded parameters injected by the attacker.


<img width="1910" height="589" alt="Screenshot 2026-02-24 104935" src="https://github.com/user-attachments/assets/9c95770e-9563-4317-ba40-b2334972e8d3" />

* HTTP Stream analysis confirming successful command execution (`ls -al webapps/ROOT/`) via the payload.
<img width="1254" height="259" alt="Screenshot 2026-02-24 105516" src="https://github.com/user-attachments/assets/53cdbb62-8cda-48ee-9163-5f5d32998529" />

<img width="1685" height="335" alt="Screenshot 2026-02-24 105702" src="https://github.com/user-attachments/assets/447de10c-8a8d-4834-9d9d-f38b17f4029e" />

---

## 2Ô∏è‚É£ Endpoint Telemetry & Process Anomalies

**Data Source:** Simulated EDR Process Execution Logs / String Artifacts

Following the initial compromise, endpoint telemetry was analyzed to identify affected processes.

Telemetry indicated that the `Tomcat6.exe` process was actively spawning system discovery commands, which deviates from expected baseline behavior for this service.

Simultaneously, network sensors logged outbound traffic from the compromised web server to an internal database server over TCP Port 1433 (TDS). EDR artifacts confirmed the `sqlservr.exe` process was targeted during this activity.

### Evidence

* Endpoint telemetry artifact highlighting the compromised `Tomcat6.exe` process.

<img width="1554" height="123" alt="Screenshot 2026-02-24 105227" src="https://github.com/user-attachments/assets/527499b7-5dfd-475e-8212-eddc46290a0b" />


* Network intrusion detection alert context showing TDS (Port 1433) NTLMSSP traffic.

<img width="1919" height="492" alt="Screenshot 2026-02-24 105051" src="https://github.com/user-attachments/assets/4a679f77-bf5b-410e-a50d-ef4f16e7f7df" />

* Endpoint artifact highlighting the targeted `sqlservr.exe` process.

<img width="1532" height="304" alt="Screenshot 2026-02-24 105323" src="https://github.com/user-attachments/assets/b9145bd8-573e-489c-88c8-ef56ddd0d2c8" />

---

## 3Ô∏è‚É£ Web Shell Deployment Tracking

**Data Source:** HTTP Traffic Analysis

Traffic analysis showed the attacker authenticating to the `/manager/html` administrative interface of Apache Tomcat to establish persistent access.

Using a multipart form-data POST request, the attacker uploaded a web archive (`wsexample.war`). The application deployed this archive, which contained two functional JSP web shells (`id_win.jsp` and `one-lin.jsp`).

<img width="1910" height="589" alt="Screenshot 2026-02-24 104935" src="https://github.com/user-attachments/assets/84d09e13-c43b-4235-b5a5-804106aee766" />

### Evidence

* HTTP access logs displaying the Tomcat Manager upload event, followed by GET requests to the deployed web shells.


* PCAP reconstruction of the multipart form-data upload containing the `wsexample.war` payload.


<img width="1565" height="225" alt="Screenshot 2026-02-24 105856" src="https://github.com/user-attachments/assets/51178029-3efd-4183-969b-8a0583252dc4" />

---
## 4Ô∏è‚É£ Lateral Movement & Data Staging Detection

**Data Source:** PCAP / Network Security Monitoring (NSM)

Further malicious network activity was executed through the deployed web shell. The attacker utilized the web shell to execute a PowerShell script (`connect.ps1`).

A Local Data Staging alert was generated during this phase. The attacker used Windows commands to copy the Active Directory database (`ntds.dit`), the SAM registry hive, and a text file (`employee.txt`) into the `C:\inetpub\wwwroot\` directory.

Placing OS files into a public-facing web directory is a standard exfiltration technique allowing download via HTTP. The attacker subsequently executed commands to delete default IIS files (e.g., `iisstart.htm`) to obscure the staged files.

### Evidence

* Network traffic showing the attacker calling the PowerShell script via the web shell parameter (`file=C:\script\connect.ps1`).

<img width="1866" height="230" alt="Screenshot 2026-02-24 105011" src="https://github.com/user-attachments/assets/1a943e13-1010-4a0d-b410-da01bc55b705" />

* HTTP requests capturing the commands used to stage the credentials (`ntds.dit` and `SAM`) into the IIS web root.

<img width="1919" height="590" alt="Screenshot 2026-02-24 105356" src="https://github.com/user-attachments/assets/aff49cbd-7c89-474c-9b7a-7975ae6b8710" />


* Traffic indicating file deletion commands targeting default IIS files.

<img width="1919" height="268" alt="Screenshot 2026-02-24 105433" src="https://github.com/user-attachments/assets/168c48d1-e7cc-48d7-89bb-ede045069f43" />


---

## 5Ô∏è‚É£ SOC Detection Engineering

Based on the artifacts identified in this investigation, the following behavioral detection rules have been proposed to improve future visibility.

| Detection Focus        | Observable Indicator                    | Proposed SIEM/EDR Logic                                                                               |
| ---------------------- | --------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| WAF Evasion            | Base64 strings in `pfdrid` parameter    | Ensure WAF deep packet inspection decodes PrimeFaces parameters prior to evaluating length thresholds |
| JSP Command Execution  | `Runtime.getRuntime().exec()`           | Implement FIM alerts for `.jsp` files containing native OS command execution classes                  |
| JSP Network Proxying   | `java.net.Socket`                       | Alert on `.jsp` files utilizing raw socket connections to detect potential HTTP tunneling             |
| Anomalous Process Tree | `Tomcat6.exe` spawning `powershell.exe` | Implement EDR rule flagging web server services spawning command interpreters                         |
| Data Staging           | `.dit` or `SAM` files in `\inetpub\`    | Generate SIEM alert for registry hives or AD database files written to web-accessible directories     |

---

## ‚è±Ô∏è Attack Timeline

| Event Phase      | Activity Description                                                                         |
| ---------------- | -------------------------------------------------------------------------------------------- |
| Initial Access   | Exploit delivered via PrimeFaces parameters (`pfdrt`, `ln`, `pfdrid`)                        |
| Discovery        | Executed `whoami` and directory listings via the exploit URL parameters                      |
| Web Shell Drop   | Attacker accessed Tomcat Manager and uploaded a WAR archive, deploying `id_win.jsp`          |
| Lateral Movement | Executed `connect.ps1` via the web shell and generated TDS/MSSQL (Port 1433) traffic         |
| Data Staging     | Credential files (`ntds.dit`, `SAM`) and `employee.txt` were copied to `C:\inetpub\wwwroot\` |
| Defense Evasion  | Executed cleanup commands (`del C:\inetpub\wwwroot\iisstart.htm`)                            |

---

## üó∫Ô∏è MITRE ATT&CK Mapping

| Tactic            | ID        | Technique                                       |
| ----------------- | --------- | ----------------------------------------------- |
| Initial Access    | T1190     | Exploit Public-Facing Application               |
| Execution         | T1059.001 | Command and Scripting Interpreter: PowerShell   |
| Persistence       | T1505.003 | Server Software Component: Web Shell            |
| Credential Access | T1003.002 | OS Credential Dumping: Security Account Manager |
| Credential Access | T1003.003 | OS Credential Dumping: NTDS                     |
| Collection        | T1074.001 | Data Staged: Local Data Staging                 |
| Defense Evasion   | T1070.004 | Indicator Removal: File Deletion                |

---

## üßæ Conclusion

The investigation confirmed the compromise of the public-facing Java application. The attacker utilized a PrimeFaces vulnerability, bypassing existing WAF rules by managing the size of the Base64 payload. Log analysis tracked the progression from initial access to the deployment of JSP web shells via the Tomcat Manager interface. Internal lateral movement attempts (Port 1433) and the staging of Active Directory files (`ntds.dit`) in a public web directory were also confirmed. Detection logic updates have been recommended based on the observed IoCs and behavioral patterns.


